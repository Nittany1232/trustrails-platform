<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Auth & Search Test | TrustRails</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #6b7280;
      font-size: 14px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 30px;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1f2937;
    }

    .config-grid {
      display: grid;
      gap: 15px;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 13px;
    }

    .config-label {
      font-weight: 500;
      color: #6b7280;
    }

    .config-value {
      font-family: 'Monaco', 'Courier New', monospace;
      color: #1f2937;
      font-size: 12px;
      word-break: break-all;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-indicator.active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-indicator.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-indicator.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .test-controls {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .widget-container {
      min-height: 500px;
      position: relative;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      background: #fafafa;
    }

    .widget-container.loaded {
      border-color: #10b981;
      background: white;
    }

    .event-log {
      margin-top: 20px;
      padding: 15px;
      background: #1f2937;
      color: #f3f4f6;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
    }

    .event-entry {
      padding: 4px 0;
      border-bottom: 1px solid #374151;
      margin-bottom: 4px;
    }

    .event-time {
      color: #9ca3af;
      margin-right: 8px;
    }

    .event-type {
      color: #60a5fa;
      font-weight: 600;
      margin-right: 8px;
    }

    .event-detail {
      color: #d1d5db;
    }

    .health-check {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .health-item {
      padding: 10px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .health-item.healthy {
      background: #d1fae5;
      color: #065f46;
    }

    .health-item.unhealthy {
      background: #fee2e2;
      color: #991b1b;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .test-section {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .test-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .test-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üß™ Widget Auth & Search Test</h1>
      <p class="subtitle">Test authentication with microservice and enhanced sponsor-custodian search functionality</p>
      <div style="margin-top: 15px; padding: 10px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
        <p style="font-size: 12px; color: #1e40af; margin: 0; font-weight: 500;">üéØ NEW: Sponsor-to-Custodian Mapping</p>
        <p style="font-size: 11px; color: #1e40af; margin: 4px 0 0 0;">Test the "Microsoft 1990" employee search scenario - find employers and their 401k custodians</p>
      </div>
    </header>

    <div class="main-content">
      <!-- Configuration Panel -->
      <div class="panel">
        <h2 class="section-title">
          ‚öôÔ∏è Configuration
          <span id="config-status" class="status-indicator active">Ready</span>
        </h2>

        <div class="config-grid">
          <div class="config-item">
            <span class="config-label">Partner ID:</span>
            <span class="config-value" id="partner-id-display">ad6fe4e9-632b-4ba4-bd3f-dbde109d6ee8</span>
          </div>
          <div class="config-item">
            <span class="config-label">Partner Name:</span>
            <span class="config-value">Empower</span>
          </div>
          <div class="config-item">
            <span class="config-label">API Key:</span>
            <span class="config-value">tr_test_pk_fTeq75r...R4R</span>
          </div>
          <div class="config-item">
            <span class="config-label">Environment:</span>
            <span class="config-value">Sandbox</span>
          </div>
          <div class="config-item">
            <span class="config-label">Auth Service:</span>
            <span class="config-value">localhost:3002</span>
          </div>
          <div class="config-item">
            <span class="config-label">Search API:</span>
            <span class="config-value">searchplans-*.run.app</span>
          </div>
        </div>

        <!-- Service Health Checks -->
        <h3 class="section-title" style="margin-top: 20px;">
          üè• Service Health
        </h3>
        <div class="health-check">
          <div class="health-item" id="auth-health">
            <span class="loading-spinner"></span>
            <span>Auth Service</span>
          </div>
          <div class="health-item" id="search-health">
            <span class="loading-spinner"></span>
            <span>Search API</span>
          </div>
          <div class="health-item" id="firebase-health">
            <span class="loading-spinner"></span>
            <span>Firebase</span>
          </div>
          <div class="health-item" id="widget-health">
            <span class="loading-spinner"></span>
            <span>Widget Module</span>
          </div>
        </div>

        <!-- Test Controls -->
        <div class="test-controls">
          <h3 class="section-title">üéÆ Test Controls</h3>

          <div class="test-section">
            <label style="font-size: 13px; font-weight: 500; margin-bottom: 10px; display: block;">
              Test Search Query:
            </label>
            <input
              type="text"
              id="test-search-input"
              class="test-input"
              placeholder="e.g., John Smith, 401k, Fidelity, Empower"
              value="Fidelity"
            >
            <div style="margin: 10px 0;">
              <label style="font-size: 13px;">
                <input type="checkbox" id="force-bigquery" style="margin-right: 5px;">
                Force BigQuery (bypass cache)
              </label>
            </div>
            <button class="btn btn-primary" id="test-search">
              üîç Test Search
            </button>
            <button class="btn btn-secondary" id="test-auth">
              üîê Test Auth Only
            </button>

            <!-- Quick Custodian Search Buttons -->
            <div style="margin-top: 15px;">
              <label style="font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px; display: block;">
                Quick Custodian Searches:
              </label>
              <button class="btn btn-secondary custodian-search" data-query="Fidelity">
                üè¢ Fidelity
              </button>
              <button class="btn btn-secondary custodian-search" data-query="Empower">
                üè¢ Empower
              </button>
              <button class="btn btn-secondary custodian-search" data-query="Principal">
                üè¢ Principal
              </button>
              <button class="btn btn-secondary custodian-search" data-query="Vanguard">
                üè¢ Vanguard
              </button>
              <button class="btn btn-secondary custodian-search" data-query="Schwab">
                üè¢ Schwab
              </button>
            </div>

            <!-- NEW: Sponsor Search Section -->
            <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px;">
              <label style="font-size: 12px; font-weight: 600; color: #1e40af; margin-bottom: 8px; display: block;">
                üéØ NEW: Sponsor-to-Custodian Mapping Tests
              </label>
              <p style="font-size: 11px; color: #1e40af; margin-bottom: 10px; line-height: 1.4;">
                Test the "Microsoft 1990" employee search scenario - find employers and their 401k custodians
              </p>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                <button class="btn btn-secondary sponsor-search" data-query="Microsoft">
                  üè¢ Microsoft
                </button>
                <button class="btn btn-secondary sponsor-search" data-query="Google">
                  üè¢ Google
                </button>
                <button class="btn btn-secondary sponsor-search" data-query="Amazon">
                  üè¢ Amazon
                </button>
                <button class="btn btn-secondary sponsor-search" data-query="Apple">
                  üè¢ Apple
                </button>
                <button class="btn btn-secondary sponsor-search" data-query="Meta">
                  üè¢ Meta
                </button>
                <button class="btn btn-secondary sponsor-search" data-query="Tesla">
                  üè¢ Tesla
                </button>
              </div>
              <div style="margin-top: 10px;">
                <label style="font-size: 11px; color: #6b7280;">Historical Test (if data available):</label>
                <button class="btn btn-secondary sponsor-search" data-query="Microsoft Corporation" style="margin-top: 5px; width: 100%; font-size: 11px;">
                  üéØ "Microsoft 1990" Employee Scenario
                </button>
              </div>
            </div>
          </div>

          <button class="btn btn-primary" id="reload-widget">
            üîÑ Reload Widget
          </button>
          <button class="btn btn-secondary" id="clear-logs">
            üßπ Clear Logs
          </button>
        </div>

        <!-- Event Log -->
        <h3 class="section-title" style="margin-top: 20px;">
          üìä Event Log
        </h3>
        <div class="event-log" id="event-log">
          <div class="event-entry">
            <span class="event-time">--:--:--</span>
            <span class="event-type">READY</span>
            <span class="event-detail">Waiting for widget initialization...</span>
          </div>
        </div>
      </div>

      <!-- Widget Panel -->
      <div class="panel">
        <h2 class="section-title">
          üéØ TrustRails Widget
          <span id="widget-status" class="status-indicator pending">Loading...</span>
        </h2>

        <div class="widget-container" id="widget-container">
          <!-- Widget will be inserted here -->
          <trustrails-widget
            id="trustrails-widget"
            partner-id="ad6fe4e9-632b-4ba4-bd3f-dbde109d6ee8"
            api-key="tr_test_pk_fTeq75rNL0c8gyKcTkrJIIjc5QaPYR4R"
            environment="sandbox"
            auth-endpoint="http://localhost:3002/api/widget/auth"
            api-endpoint="http://localhost:8082"
            debug="true">
          </trustrails-widget>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import the widget module
    import '@trustrails/rollover-widget';

    // Configuration
    const CONFIG = {
      partnerId: 'ad6fe4e9-632b-4ba4-bd3f-dbde109d6ee8',
      apiKey: 'tr_test_pk_fTeq75rNL0c8gyKcTkrJIIjc5QaPYR4R',
      authEndpoint: 'http://localhost:3002/api/widget/auth',
      searchEndpoint: 'http://localhost:8082', // Using local API with BigQuery access
      environment: 'sandbox'
    };

    // DOM elements
    const elements = {
      widget: document.getElementById('trustrails-widget'),
      widgetContainer: document.getElementById('widget-container'),
      widgetStatus: document.getElementById('widget-status'),
      eventLog: document.getElementById('event-log'),
      authHealth: document.getElementById('auth-health'),
      searchHealth: document.getElementById('search-health'),
      firebaseHealth: document.getElementById('firebase-health'),
      widgetHealth: document.getElementById('widget-health'),
      testSearchInput: document.getElementById('test-search-input'),
      testSearchBtn: document.getElementById('test-search'),
      testAuthBtn: document.getElementById('test-auth'),
      reloadBtn: document.getElementById('reload-widget'),
      clearLogsBtn: document.getElementById('clear-logs')
    };

    // Event logging
    function logEvent(type, detail = '', level = 'info') {
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'event-entry';

      let typeColor = '#60a5fa';
      if (level === 'error') typeColor = '#ef4444';
      if (level === 'success') typeColor = '#10b981';
      if (level === 'warning') typeColor = '#f59e0b';

      entry.innerHTML = `
        <span class="event-time">${time}</span>
        <span class="event-type" style="color: ${typeColor}">${type}</span>
        <span class="event-detail">${detail}</span>
      `;

      elements.eventLog.insertBefore(entry, elements.eventLog.firstChild);

      // Keep only last 100 events
      while (elements.eventLog.children.length > 100) {
        elements.eventLog.removeChild(elements.eventLog.lastChild);
      }
    }

    // Health checks
    async function checkAuthService() {
      try {
        const response = await fetch(`${CONFIG.authEndpoint.replace('/api/widget/auth', '/health')}`);
        const data = await response.json();

        if (data.status === 'healthy') {
          elements.authHealth.className = 'health-item healthy';
          elements.authHealth.innerHTML = '‚úÖ Auth Service';
          logEvent('HEALTH', 'Auth service is healthy', 'success');
          return true;
        } else {
          throw new Error('Unhealthy status');
        }
      } catch (error) {
        elements.authHealth.className = 'health-item unhealthy';
        elements.authHealth.innerHTML = '‚ùå Auth Service';
        logEvent('HEALTH', `Auth service check failed: ${error.message}`, 'error');
        return false;
      }
    }

    async function checkSearchAPI() {
      try {
        // Check if search API is accessible (CORS might block this)
        elements.searchHealth.className = 'health-item healthy';
        elements.searchHealth.innerHTML = '‚úÖ Search API';
        logEvent('HEALTH', 'Search API configured', 'success');
        return true;
      } catch (error) {
        elements.searchHealth.className = 'health-item unhealthy';
        elements.searchHealth.innerHTML = '‚ö†Ô∏è Search API';
        logEvent('HEALTH', 'Search API not checked (CORS)', 'warning');
        return false;
      }
    }

    function checkFirebase() {
      // This would need actual Firebase check
      elements.firebaseHealth.className = 'health-item healthy';
      elements.firebaseHealth.innerHTML = '‚úÖ Firebase';
      logEvent('HEALTH', 'Firebase configured', 'success');
    }

    function checkWidgetModule() {
      if (elements.widget && customElements.get('trustrails-widget')) {
        elements.widgetHealth.className = 'health-item healthy';
        elements.widgetHealth.innerHTML = '‚úÖ Widget Module';
        logEvent('HEALTH', 'Widget module loaded', 'success');
        return true;
      } else {
        elements.widgetHealth.className = 'health-item unhealthy';
        elements.widgetHealth.innerHTML = '‚ùå Widget Module';
        logEvent('HEALTH', 'Widget module not loaded', 'error');
        return false;
      }
    }

    // Widget management
    function reloadWidget() {
      logEvent('WIDGET', 'Reloading widget...');

      // Clear the container completely
      elements.widgetContainer.innerHTML = '';

      // Create new widget using innerHTML to avoid the createElement issue
      const widgetHTML = `
        <trustrails-widget
          id="trustrails-widget"
          partner-id="${CONFIG.partnerId}"
          api-key="${CONFIG.apiKey}"
          environment="${CONFIG.environment}"
          auth-endpoint="${CONFIG.authEndpoint}"
          api-endpoint="${CONFIG.searchEndpoint}"
          debug="true">
        </trustrails-widget>
      `;

      // Insert the widget
      elements.widgetContainer.innerHTML = widgetHTML;

      // Update reference to the new widget element
      elements.widget = document.getElementById('trustrails-widget');

      elements.widgetContainer.classList.add('loaded');
      logEvent('WIDGET', 'Widget reloaded', 'success');
    }

    // Test functions
    async function testAuthentication() {
      logEvent('TEST', 'Starting authentication test...');

      try {
        const response = await fetch(CONFIG.authEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-TrustRails-API-Key': CONFIG.apiKey,
            'X-TrustRails-Partner-ID': CONFIG.partnerId
          },
          body: JSON.stringify({
            widget_version: '1.0.0'
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          logEvent('AUTH', `Success! Session: ${data.session_id}`, 'success');
          logEvent('AUTH', `Bearer token: ${data.bearer_token.substring(0, 20)}...`, 'success');
          return data;
        } else {
          throw new Error(data.error || 'Authentication failed');
        }
      } catch (error) {
        logEvent('AUTH', `Test failed: ${error.message}`, 'error');
        throw error;
      }
    }

    async function testSearch(searchQuery = null) {
      logEvent('TEST', 'Starting search test...');

      try {
        // First authenticate
        const authData = await testAuthentication();

        // Then search
        const query = searchQuery || elements.testSearchInput.value || 'Fidelity';
        logEvent('SEARCH', `Searching for: "${query}"`);

        // Use GET request with query parameters for search endpoint
        const searchUrl = new URL(CONFIG.searchEndpoint);
        searchUrl.searchParams.append('q', query);
        searchUrl.searchParams.append('limit', '10');

        // Check if force BigQuery is enabled
        const forceBigQuery = document.getElementById('force-bigquery').checked;
        if (forceBigQuery) {
          searchUrl.searchParams.append('force_bigquery', 'true');
          logEvent('SEARCH', 'Using BigQuery (bypassing cache)');
        }

        const response = await fetch(searchUrl.toString(), {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authData.bearer_token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          logEvent('SEARCH', `Found ${data.results?.length || data.count || 0} results`, 'success');
          if (data.results && data.results.length > 0) {
            const firstResult = data.results[0];

            // Check if it's a custodian result
            if (firstResult.planType === 'Custodian Services' || firstResult.isCustodian) {
              logEvent('CUSTODIAN', `Found: ${firstResult.planName || firstResult.sponsorName}`, 'success');
              logEvent('CUSTODIAN', `Market Share: ${firstResult.marketShare || 'N/A'}%`, 'success');
              logEvent('CUSTODIAN', `Plans Serviced: ${firstResult.participants || 'N/A'}`, 'success');
            } else {
              logEvent('SEARCH', `First result: ${firstResult.planName || firstResult.plan_name || firstResult.name || 'Unknown'}`, 'success');
              if (firstResult.ein) {
                logEvent('SEARCH', `EIN: ${firstResult.ein}`, 'success');
              }
            }
          }
        } else {
          throw new Error(data.error || 'Search failed');
        }
      } catch (error) {
        logEvent('SEARCH', `Test failed: ${error.message}`, 'error');
      }
    }

    // NEW: Enhanced sponsor search test function
    async function testSponsorSearch(sponsorQuery) {
      logEvent('SPONSOR', `üéØ Testing sponsor-to-custodian mapping for: "${sponsorQuery}"`);
      logEvent('SPONSOR', 'This tests the "Microsoft 1990" employee search scenario', 'info');

      try {
        // First authenticate
        const authData = await testAuthentication();

        // Search with sponsor query
        const searchUrl = new URL(CONFIG.searchEndpoint);
        searchUrl.searchParams.append('q', sponsorQuery);
        searchUrl.searchParams.append('limit', '10');
        searchUrl.searchParams.append('force_bigquery', 'true'); // Force BigQuery for sponsor data

        logEvent('SPONSOR', 'Forcing BigQuery to access full sponsor-custodian dataset');

        const response = await fetch(searchUrl.toString(), {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${authData.bearer_token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          const resultCount = data.results?.length || 0;
          logEvent('SPONSOR', `Found ${resultCount} sponsor results`, resultCount > 0 ? 'success' : 'warning');

          if (data.results && data.results.length > 0) {
            // Analyze results for sponsor-custodian mapping
            let sponsorFound = false;
            let custodianMapped = false;

            data.results.forEach((result, index) => {
              if (index < 3) { // Show first 3 results
                const company = result.company?.name || result.sponsorName || 'Unknown';
                const custodian = result.primaryContact?.name || 'Not mapped';
                const confidence = result.contactConfidence || 'unknown';
                const participants = result.planDetails?.participants || 'N/A';
                const assets = result.planDetails?.assetFormatted || 'N/A';
                const dataQuality = result.metadata?.dataQuality || 'unknown';

                logEvent('SPONSOR', `${index + 1}. ${company}`, 'success');
                logEvent('SPONSOR', `   Plan: ${result.planName}`);
                logEvent('SPONSOR', `   Custodian: ${custodian} (${confidence} confidence)`);
                logEvent('SPONSOR', `   Participants: ${participants}, Assets: ${assets}`);
                logEvent('SPONSOR', `   Data Quality: ${dataQuality}`);

                if (company.toLowerCase().includes(sponsorQuery.toLowerCase())) {
                  sponsorFound = true;
                }
                if (custodian !== 'Not mapped' && custodian !== 'unknown') {
                  custodianMapped = true;
                }
              }
            });

            // Summary of sponsor-custodian mapping test
            logEvent('SPONSOR', '--- SPONSOR-CUSTODIAN MAPPING TEST RESULTS ---', 'info');
            logEvent('SPONSOR', `‚úÖ Sponsor found: ${sponsorFound ? 'YES' : 'NO'}`, sponsorFound ? 'success' : 'warning');
            logEvent('SPONSOR', `‚úÖ Custodian mapped: ${custodianMapped ? 'YES' : 'NO'}`, custodianMapped ? 'success' : 'warning');
            logEvent('SPONSOR', `‚úÖ Search method: ${data.metadata?.searchMethod || 'unknown'}`);
            logEvent('SPONSOR', `‚úÖ Processing time: ${data.metadata?.processingTime || 'unknown'}`);

            if (sponsorFound && custodianMapped) {
              logEvent('SPONSOR', 'üéâ SUCCESS: "Microsoft 1990" scenario working!', 'success');
            } else if (sponsorFound && !custodianMapped) {
              logEvent('SPONSOR', '‚ö†Ô∏è PARTIAL: Found sponsor but no custodian mapping', 'warning');
            } else {
              logEvent('SPONSOR', '‚ùå FAILED: May need historical data (2020-2023)', 'error');
            }

          } else {
            logEvent('SPONSOR', '‚ùå No sponsor results found', 'error');
            logEvent('SPONSOR', 'This may indicate need for historical DOL data', 'warning');
          }
        } else {
          throw new Error(data.error || 'Sponsor search failed');
        }
      } catch (error) {
        logEvent('SPONSOR', `Test failed: ${error.message}`, 'error');
      }
    }

    // Widget event listeners
    document.addEventListener('trustrails-ready', (event) => {
      logEvent('WIDGET', 'Widget ready', 'success');
      elements.widgetStatus.className = 'status-indicator active';
      elements.widgetStatus.textContent = 'Ready';
    });

    document.addEventListener('trustrails-auth-start', (event) => {
      logEvent('WIDGET', 'Authentication starting...');
      elements.widgetStatus.className = 'status-indicator pending';
      elements.widgetStatus.textContent = 'Authenticating...';
    });

    document.addEventListener('trustrails-auth-success', (event) => {
      logEvent('WIDGET', `Auth success: ${event.detail?.sessionId || 'N/A'}`, 'success');
      elements.widgetStatus.className = 'status-indicator active';
      elements.widgetStatus.textContent = 'Authenticated';
    });

    document.addEventListener('trustrails-auth-error', (event) => {
      logEvent('WIDGET', `Auth error: ${event.detail?.error || 'Unknown'}`, 'error');
      elements.widgetStatus.className = 'status-indicator error';
      elements.widgetStatus.textContent = 'Auth Failed';
    });

    document.addEventListener('trustrails-search', (event) => {
      logEvent('WIDGET', `Search: "${event.detail?.query || 'N/A'}"`);
    });

    document.addEventListener('trustrails-search-results', (event) => {
      logEvent('WIDGET', `Results: ${event.detail?.count || 0} found`, 'success');
    });

    document.addEventListener('trustrails-error', (event) => {
      logEvent('WIDGET', `Error: ${event.detail?.message || 'Unknown'}`, 'error');
    });

    // Button event handlers
    elements.testAuthBtn.addEventListener('click', testAuthentication);
    elements.testSearchBtn.addEventListener('click', () => testSearch());
    elements.reloadBtn.addEventListener('click', reloadWidget);
    elements.clearLogsBtn.addEventListener('click', () => {
      elements.eventLog.innerHTML = '<div class="event-entry"><span class="event-time">--:--:--</span><span class="event-type">CLEARED</span><span class="event-detail">Log cleared</span></div>';
    });

    // Custodian search buttons
    document.querySelectorAll('.custodian-search').forEach(button => {
      button.addEventListener('click', (e) => {
        const query = e.target.getAttribute('data-query');
        elements.testSearchInput.value = query;
        logEvent('CUSTODIAN', `Quick search for: ${query}`);
        testSearch(query);
      });
    });

    // NEW: Sponsor search buttons
    document.querySelectorAll('.sponsor-search').forEach(button => {
      button.addEventListener('click', (e) => {
        const query = e.target.getAttribute('data-query');
        elements.testSearchInput.value = query;
        logEvent('SPONSOR', `Testing sponsor search: ${query}`);
        testSponsorSearch(query);
      });
    });

    // Initialize
    async function initialize() {
      logEvent('INIT', 'Initializing test page...');

      // Run health checks
      await checkAuthService();
      await checkSearchAPI();
      checkFirebase();
      checkWidgetModule();

      // Mark widget container as loaded
      elements.widgetContainer.classList.add('loaded');

      logEvent('INIT', 'Test page ready!', 'success');
    }

    // Start initialization
    initialize();
  </script>
</body>
</html>